# https://taskfile.dev

version: '3'

tasks:
  generate-migrations-sqlite:
    deps:
      - check-migration-name
    cmds:
      - rm -rf ./build/migrations/sqlite-schema
      - go run ./pkg/db/migration/templates ./build/migrations/sqlite-schema sqlite
      - atlas migrate diff --dir="file://pkg/db/migration/sqlite?format=goose" --to=file://./build/migrations/sqlite-schema --dev-url "sqlite://file?mode=memory" {{ .MIGRATION_NAME }}
  generate-migrations-postgres:
    deps:
      - check-migration-name
    cmds:
      - rm -rf ./build/migrations/postgres-schema
      - go run ./pkg/db/migration/templates ./build/migrations/postgres-schema postgres
      - atlas migrate diff "--dir=file://pkg/db/migration/postgres?format=goose" --to=file://./build/migrations/postgres-schema --dev-url "docker://postgres/17/dev?search_path=public" {{ .MIGRATION_NAME }}

  check-migration-name:
    run: once
    cmds:
      - echo "checking MIGRATION_NAME"
      - if [ "{{ .MIGRATION_NAME }}" = "" ]; then echo "please provide MIGRATION_NAME=xxx to the task invocation"; exit 1; fi

  generate-migrations:
    deps:
      - check-migration-name
      - generate-migrations-sqlite
      - generate-migrations-postgres